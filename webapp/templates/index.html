<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DroneMission — Mission Visualization</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; background: #0f1419; color: #e6edf3; }
    h1 { font-size: 1.5rem; }
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .tabs button { padding: 0.5rem 1rem; cursor: pointer; background: #21262d; border: 1px solid #30363d; color: #e6edf3; border-radius: 6px; }
    .tabs button.active { background: #238636; border-color: #238636; }
    .panel { display: none; padding: 1rem; background: #161b22; border-radius: 8px; border: 1px solid #30363d; }
    .panel.active { display: block; }
    .metrics { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
    .metric { padding: 0.5rem; background: #21262d; border-radius: 6px; }
    .metric span { display: block; font-size: 0.75rem; color: #8b949e; }
    .metric strong { font-size: 1.1rem; }
    #map { height: 360px; width: 100%; border-radius: 6px; margin-top: 0.5rem; }
    .schedule-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .schedule-table th, .schedule-table td { padding: 0.4rem 0.6rem; text-align: left; border: 1px solid #30363d; }
    .schedule-table th { background: #21262d; }
    pre { overflow: auto; font-size: 0.85rem; padding: 1rem; background: #0d1117; border-radius: 6px; }
    .error { color: #f85149; }
    .start-mission-bar { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
    .start-mission-btn { padding: 0.6rem 1.2rem; font-size: 1rem; cursor: pointer; background: #238636; border: 1px solid #2ea043; color: #fff; border-radius: 6px; }
    .start-mission-btn:hover:not(:disabled) { background: #2ea043; }
    .start-mission-btn:disabled { opacity: 0.7; cursor: not-allowed; }
    #start-mission-status { color: #8b949e; }
    #start-mission-status.running { color: #58a6ff; }
    #start-mission-status.error { color: #f85149; }
    .placeholder { color: #8b949e; margin: 0.5rem 0; }
    code { background: #21262d; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>DroneMission — Mission Visualization</h1>
  <p>Unified aircraft + spacecraft mission planning (AeroHack). The mission is defined in <code>src/mission_settings.py</code> (waypoints, model, targets).</p>

  <div class="start-mission-bar">
    <button type="button" id="start-mission-btn" class="start-mission-btn">Start mission</button>
    <span id="start-mission-status"></span>
  </div>

  <div class="tabs">
    <button type="button" class="tab active" data-panel="aircraft">Aircraft mission</button>
    <button type="button" class="tab" data-panel="spacecraft">Spacecraft mission</button>
  </div>

  <div id="aircraft" class="panel active">
    <h2>Aircraft mission</h2>
    <div id="aircraft-metrics" class="metrics"></div>
    <div id="aircraft-route">
      <p id="aircraft-placeholder" class="placeholder">Click <strong>Start mission</strong> above to run the mission from settings and show the route on the map.</p>
      <div id="map" style="display: none;"></div>
    </div>
  </div>

  <div id="spacecraft" class="panel">
    <h2>Spacecraft mission (7-day)</h2>
    <div id="spacecraft-metrics" class="metrics"></div>
    <div id="spacecraft-schedule"></div>
  </div>

  <script>
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.panel');
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.panel;
        tabs.forEach(b => b.classList.remove('active'));
        panels.forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(id).classList.add('active');
      });
    });

    function showAircraftMap(route) {
      const placeholder = document.getElementById('aircraft-placeholder');
      const mapEl = document.getElementById('map');
      if (!route.length || typeof L === 'undefined') {
        if (placeholder) placeholder.style.display = '';
        if (mapEl) mapEl.style.display = 'none';
        return;
      }
      if (placeholder) placeholder.style.display = 'none';
      if (mapEl) mapEl.style.display = 'block';
      if (window._aircraftMap) {
        window._aircraftMap.remove();
        window._aircraftMap = null;
      }
      const map = L.map('map').setView([route[0].lat ?? route[0][0], route[0].lon ?? route[0][1]], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
      const pts = route.map(p => [p.lat ?? p[0], p.lon ?? p[1]]);
      L.polyline(pts, { color: '#238636', weight: 4 }).addTo(map);
      route.forEach((p, i) => {
        const lat = p.lat ?? p[0];
        const lon = p.lon ?? p[1];
        const t = p.t != null ? ' t=' + p.t.toFixed(0) + ' s' : '';
        L.marker([lat, lon]).addTo(map).bindPopup('WP' + (i + 1) + t);
      });
      map.fitBounds(pts, { padding: [20, 20] });
      window._aircraftMap = map;
    }

    async function loadAircraft() {
      const metrics = document.getElementById('aircraft-metrics');
      const placeholder = document.getElementById('aircraft-placeholder');
      const mapEl = document.getElementById('map');
      try {
        const r = await fetch('/api/aircraft');
        if (!r.ok) {
          const err = (await r.json()).error || 'No aircraft mission.';
          if (placeholder) { placeholder.textContent = err + ' Click Start mission to run the mission from settings and show the route on the map.'; placeholder.style.display = ''; }
          if (mapEl) mapEl.style.display = 'none';
          metrics.innerHTML = '';
          return;
        }
        const d = await r.json();
        metrics.innerHTML = [
          '<div class="metric"><span>Total time</span><strong>' + (d.total_time_s != null ? d.total_time_s.toFixed(1) + ' s' : '—') + '</strong></div>',
          '<div class="metric"><span>Total energy</span><strong>' + (d.total_energy != null ? d.total_energy.toFixed(0) : '—') + '</strong></div>',
          '<div class="metric"><span>Monte-Carlo success</span><strong>' + (d.monte_carlo && d.monte_carlo.success_rate != null ? (d.monte_carlo.success_rate * 100).toFixed(0) + '%' : '—') + '</strong></div>'
        ].join('');
        const route = d.planned_route || d.flight_path_with_timestamps || [];
        showAircraftMap(route);
      } catch (e) {
        if (placeholder) { placeholder.textContent = 'Failed to load aircraft data. Click Start mission to run the mission.'; placeholder.style.display = ''; }
        if (mapEl) mapEl.style.display = 'none';
        metrics.innerHTML = '';
      }
    }

    async function loadSpacecraft() {
      const el = document.getElementById('spacecraft-schedule');
      const metrics = document.getElementById('spacecraft-metrics');
      try {
        const r = await fetch('/api/spacecraft');
        if (!r.ok) {
          el.innerHTML = '<p class="error">' + (await r.json()).error + '</p>';
          return;
        }
        const d = await r.json();
        metrics.innerHTML = [
          '<div class="metric"><span>Mission value</span><strong>' + (d.mission_value != null ? d.mission_value : '—') + '</strong></div>',
          '<div class="metric"><span>Schedule days</span><strong>' + (d.schedule_days != null ? d.schedule_days : '—') + '</strong></div>',
          '<div class="metric"><span>Activities</span><strong>' + (d.activities ? d.activities.length : 0) + '</strong></div>'
        ].join('');
        const acts = d.activities || [];
        if (acts.length) {
          let table = '<table class="schedule-table"><thead><tr><th>Type</th><th>Start (s)</th><th>End (s)</th><th>Duration (s)</th><th>Target</th></tr></thead><tbody>';
          acts.forEach(a => {
            const dur = (a.end_t - a.start_t).toFixed(0);
            table += '<tr><td>' + (a.type || '') + '</td><td>' + a.start_t + '</td><td>' + a.end_t + '</td><td>' + dur + '</td><td>' + (a.target_idx != null ? a.target_idx : '—') + '</td></tr>';
          });
          table += '</tbody></table>';
          el.innerHTML = table;
        } else {
          el.innerHTML = '<p>No activities in schedule.</p>';
        }
      } catch (e) {
        el.innerHTML = '<p class="error">Failed to load spacecraft data.</p>';
      }
    }

    document.getElementById('start-mission-btn').addEventListener('click', async function() {
      const btn = this;
      const status = document.getElementById('start-mission-status');
      btn.disabled = true;
      status.textContent = 'Running mission…';
      status.className = 'running';
      status.classList.remove('error');
      try {
        const r = await fetch('/api/start_mission', { method: 'POST' });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          status.textContent = 'Error: ' + (data.error || r.statusText);
          status.className = 'error';
          return;
        }
        status.textContent = 'Done. Showing visualization.';
        await loadAircraft();
        await loadSpacecraft();
      } catch (e) {
        status.textContent = 'Error: ' + e.message;
        status.className = 'error';
      } finally {
        btn.disabled = false;
      }
    });

    loadAircraft();
    loadSpacecraft();
  </script>
</body>
</html>
