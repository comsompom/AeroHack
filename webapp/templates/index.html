<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DroneMission — Mission Visualization</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    * { box-sizing: border-box; }
    html, body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: #0f1419; color: #e6edf3; min-height: 100vh; overflow: auto; }
    body { height: 100%; }
    .app { display: flex; min-height: 100vh; height: 100%; }
    .panel-left { width: 320px; min-width: 320px; max-height: 100vh; background: #282a2e; border-right: 1px solid #30363d; overflow-y: auto; overflow-x: hidden; padding: 10px; flex-shrink: 0; }
    .viz-right { flex: 1; display: flex; flex-direction: column; min-width: 0; min-height: 0; overflow: auto; max-height: 100vh; }
    h1 { font-size: 1.1rem; margin: 0 0 8px 0; }
    .tabs { display: flex; gap: 4px; margin-bottom: 12px; }
    .tabs button { padding: 6px 10px; cursor: pointer; background: #3c3f44; border: 1px solid #30363d; color: #e6edf3; border-radius: 6px; font-size: 14px; }
    .tabs button.active { background: #007830; border-color: #007830; }
    .panel { display: none; }
    .panel.active { display: block; }
    .section-title { font-size: 13px; color: #b0b6bc; margin: 14px 0 6px 0; }
    .setting-line { font-size: 13px; color: #e6edf3; margin: 4px 0; }
    .metric { display: inline-block; padding: 4px 8px; background: #21262d; border-radius: 4px; margin: 2px 4px 2px 0; font-size: 12px; }
    .metric span { color: #8b949e; margin-right: 4px; }
    .btn { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 8px; }
    .btn-start { background: #007830; color: #fff; }
    .btn-start:hover:not(:disabled) { background: #2ea043; }
    .btn-start:disabled { opacity: 0.7; cursor: not-allowed; }
    .btn-plan { background: #504080; color: #fff; }
    .btn-small { padding: 4px 10px; font-size: 12px; margin: 4px 0; background: #3d4a56; color: #e6edf3; }
    .hint { font-size: 11px; color: #8b949e; margin: 4px 0 8px 0; }
    #start-mission-status, #plan-aircraft-status { font-size: 12px; color: #8b949e; margin-left: 8px; }
    #start-mission-status.running, #plan-aircraft-status.running { color: #58a6ff; }
    #start-mission-status.error, #plan-aircraft-status.error { color: #f85149; }
    .error { color: #f85149; }
    .placeholder { color: #8b949e; font-size: 13px; padding: 1rem; }
    #map { flex: 1; min-height: 300px; border-radius: 0; }
    #spacecraft-canvas { flex: 1; min-height: 300px; width: 100%; display: block; background: #1a1d21; }
    #aircraft-viz.panel.active, #spacecraft-viz.panel.active { min-height: 0; overflow: auto; }
    .schedule-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
    .schedule-table th, .schedule-table td { padding: 4px 8px; text-align: left; border: 1px solid #30363d; }
    .schedule-table th { background: #21262d; }
    .waypoints-list { max-height: 120px; overflow-y: auto; font-size: 11px; color: #b0b6bc; }
    .crash-msg { color: #f85149; font-weight: bold; margin-top: 6px; }
    .fail-msg { color: #e08250; font-weight: bold; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel-left">
      <h1>DroneMission — Viz</h1>
      <p style="font-size: 11px; color: #8b949e;">Same settings as Pygame app (from mission_settings).</p>
      <div class="tabs">
        <button type="button" class="tab active" data-panel="aircraft">Aircraft</button>
        <button type="button" class="tab" data-panel="spacecraft">Spacecraft</button>
      </div>

      <div id="aircraft-settings" class="panel active">
        <div class="section-title">Aircraft mission</div>
        <p class="hint">One waypoint per line: lat, lon or lat, lon, alt_m</p>
        <textarea id="aircraft-waypoints-ta" rows="5" style="width:100%;max-width:280px;font-size:12px;padding:6px;background:#21262d;color:#e6edf3;border:1px solid #30363d;border-radius:4px;resize:vertical;"></textarea>
        <div class="section-title">Default altitude (m)</div>
        <div class="setting-line">
          <input type="number" id="aircraft-altitude-m" min="0" max="4000" value="100" style="width:72px;">
        </div>
        <div class="section-title">Vehicle type</div>
        <div class="setting-line">
          <select id="aircraft-vehicle-type" style="padding:4px 8px;background:#21262d;color:#e6edf3;border:1px solid #30363d;border-radius:4px;">
            <option value="Plane">Plane (fuel)</option>
            <option value="UAV">UAV / Drone (battery)</option>
          </select>
        </div>
        <div class="section-title">Fuel / Battery capacity (J)</div>
        <div class="setting-line">
          <input type="number" id="aircraft-energy-capacity" min="1000" step="100000" value="2000000" style="width:120px;">
        </div>
        <div class="section-title">Consumption (J/s)</div>
        <div class="setting-line">
          <input type="number" id="aircraft-consumption" min="1" step="1" value="80" style="width:72px;">
        </div>
        <div id="aircraft-crash-msg" class="crash-msg" style="display: none;"></div>
        <div id="aircraft-fail-msg" class="fail-msg" style="display: none;"></div>
        <button type="button" id="plan-aircraft-btn" class="btn btn-start">Plan aircraft + Save</button>
        <span id="plan-aircraft-status"></span>
        <div style="margin-top:12px;">
          <button type="button" id="start-mission-btn" class="btn btn-small">Start mission (from file)</button>
          <span id="start-mission-status"></span>
        </div>
        <div id="aircraft-metrics" style="margin-top: 10px;"></div>
      </div>

      <div id="spacecraft-settings" class="panel">
        <div class="section-title">7-day spacecraft mission</div>
        <div class="setting-line">Targets (from waypoints):</div>
        <div id="spacecraft-targets-list" class="waypoints-list"></div>
        <p class="hint">Drag globe to rotate. Click globe to set launch.</p>
        <div class="section-title">Launch point (lat, lon)</div>
        <div class="setting-line">
          <input type="number" id="launch-lat" step="0.5" min="-90" max="90" style="width:64px;margin-right:6px;"> 
          <input type="number" id="launch-lon" step="0.5" min="-180" max="180" style="width:64px;">
        </div>
        <button type="button" id="set-launch-from-start-btn" class="btn btn-small">Set from start</button>
        <div class="section-title">Orbit altitude (km)</div>
        <div class="setting-line">
          <input type="number" id="orbit-alt-km" min="200" max="2000" value="400" style="width:72px;">
        </div>
        <div class="section-title">Weather at launch</div>
        <div id="weather-at-launch" class="setting-line">—</div>
        <button type="button" id="plan-spacecraft-btn" class="btn btn-plan">Plan 7-day + Save</button>
        <div id="spacecraft-metrics" style="margin-top: 10px;"></div>
        <div id="spacecraft-schedule-wrap" style="margin-top: 8px;"></div>
      </div>
    </aside>

    <main class="viz-right">
      <div id="aircraft-viz" class="panel active" style="flex: 1; display: flex; flex-direction: column;">
        <p id="aircraft-placeholder" class="placeholder">Click <strong>Start mission</strong> to run and show the route. Plane animates along path; crash/fail shown if fuel/battery runs out.</p>
        <div id="map" style="display: none; flex: 1;"></div>
      </div>
      <div id="spacecraft-viz" class="panel" style="flex: 1; display: flex; flex-direction: column;">
        <p class="placeholder">Full Earth: drag to rotate, click globe to set launch. Same as Pygame.</p>
        <canvas id="spacecraft-canvas"></canvas>
      </div>
    </main>
  </div>

  <script>
    const tabs = document.querySelectorAll('.tab');
    const aircraftSettings = document.getElementById('aircraft-settings');
    const spacecraftSettings = document.getElementById('spacecraft-settings');
    const aircraftViz = document.getElementById('aircraft-viz');
    const spacecraftViz = document.getElementById('spacecraft-viz');
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.panel;
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        aircraftSettings.classList.toggle('active', id === 'aircraft');
        spacecraftSettings.classList.toggle('active', id === 'spacecraft');
        aircraftViz.classList.toggle('active', id === 'aircraft');
        spacecraftViz.classList.toggle('active', id === 'spacecraft');
        if (id === 'aircraft' && window._aircraftMap) window._aircraftMap.invalidateSize();
        if (id === 'spacecraft') drawSpacecraftView();
      });
    });

    let settings = null;
    let aircraftData = null;
    let replayStartTime = null;
    let replayInterval = null;
    const FLIGHT_SPEED = 40;
    let earthRotationRad = 0;
    let earthDragStart = null;
    let earthImage = null;
    const EARTH_IMAGE_URL = 'https://unpkg.com/three-globe/example/img/earth-day.jpg';

    async function loadSettings() {
      try {
        const r = await fetch('/api/settings');
        if (!r.ok) return;
        settings = await r.json();
        const wps = settings.aircraft.waypoints || [];
        const ta = document.getElementById('aircraft-waypoints-ta');
        if (ta) ta.value = wps.map(w => w[0] + ', ' + w[1] + (w[2] != null ? ', ' + w[2] : '')).join('\n');
        const altEl = document.getElementById('aircraft-altitude-m');
        if (altEl) altEl.value = settings.aircraft.default_altitude_m ?? 100;
        const vtEl = document.getElementById('aircraft-vehicle-type');
        if (vtEl) vtEl.value = settings.aircraft.vehicle_type || 'Plane';
        const capEl = document.getElementById('aircraft-energy-capacity');
        if (capEl) capEl.value = settings.aircraft.energy_budget ?? 2000000;
        const consEl = document.getElementById('aircraft-consumption');
        if (consEl) consEl.value = settings.aircraft.consumption_per_second ?? 80;
        const st = settings.spacecraft.station || [52, 4];
        const launchLatEl = document.getElementById('launch-lat');
        const launchLonEl = document.getElementById('launch-lon');
        const orbitAltEl = document.getElementById('orbit-alt-km');
        if (launchLatEl) launchLatEl.value = st[0];
        if (launchLonEl) launchLonEl.value = st[1];
        if (orbitAltEl) orbitAltEl.value = settings.spacecraft.altitude_km ?? 400;
        const tlist = document.getElementById('spacecraft-targets-list');
        tlist.innerHTML = (settings.spacecraft.targets || []).slice(0, 4).map(t =>
          t[0].toFixed(2) + ', ' + t[1].toFixed(2)
        ).join('<br>');
        fetchWeatherAtLaunch();
      } catch (e) {}
    }

    async function fetchWeatherAtLaunch() {
      const latEl = document.getElementById('launch-lat');
      const lonEl = document.getElementById('launch-lon');
      const out = document.getElementById('weather-at-launch');
      if (!out || !latEl || !lonEl) return;
      const lat = parseFloat(latEl.value);
      const lon = parseFloat(lonEl.value);
      if (isNaN(lat) || isNaN(lon)) { out.textContent = '—'; return; }
      try {
        const r = await fetch('/api/weather?lat=' + lat + '&lon=' + lon);
        if (!r.ok) { out.textContent = '—'; return; }
        const w = await r.json();
        out.textContent = (w.temperature != null ? w.temperature + '°C' : '—') + ', wind ' + (w.windspeed != null ? w.windspeed + ' km/h' : '—');
      } catch (e) { out.textContent = '—'; }
    }

    function interpolate(route, t) {
      if (!route || !route.length) return null;
      const lat = (p) => p.lat ?? p[0], lon = (p) => p.lon ?? p[1];
      if (t <= (route[0].t || 0)) return { lat: lat(route[0]), lon: lon(route[0]) };
      if (t >= (route[route.length - 1].t || 0)) {
        const last = route[route.length - 1];
        return { lat: lat(last), lon: lon(last) };
      }
      for (let i = 0; i < route.length - 1; i++) {
        const a = route[i], b = route[i + 1];
        const t0 = a.t ?? 0, t1 = b.t ?? 0;
        if (t0 <= t && t <= t1) {
          const dt = t1 - t0;
          if (dt <= 0) return { lat: lat(b), lon: lon(b) };
          const f = (t - t0) / dt;
          return {
            lat: lat(a) + f * (lat(b) - lat(a)),
            lon: lon(a) + f * (lon(b) - lon(a))
          };
        }
      }
      return null;
    }

    function interpolateEnergy(route, t) {
      if (!route || !route.length) return null;
      const budget = aircraftData && aircraftData.model_parameters && aircraftData.model_parameters.energy_budget;
      if (budget == null) return null;
      if (route[0].energy_used == null) return null;
      if (t <= (route[0].t || 0)) return { energy_used: route[0].energy_used ?? 0, budget };
      if (t >= (route[route.length - 1].t || 0)) return { energy_used: route[route.length - 1].energy_used ?? 0, budget };
      for (let i = 0; i < route.length - 1; i++) {
        const a = route[i], b = route[i + 1];
        const t0 = a.t ?? 0, t1 = b.t ?? 0;
        if (t0 <= t && t <= t1) {
          const dt = t1 - t0;
          if (dt <= 0) return { energy_used: b.energy_used ?? 0, budget };
          const f = (t - t0) / dt;
          const e = (a.energy_used ?? 0) + f * ((b.energy_used ?? 0) - (a.energy_used ?? 0));
          return { energy_used: e, budget };
        }
      }
      return null;
    }

    function showAircraftMap(route, withReplay) {
      const placeholder = document.getElementById('aircraft-placeholder');
      const mapEl = document.getElementById('map');
      if (!route || !route.length || typeof L === 'undefined') {
        placeholder.style.display = 'block';
        mapEl.style.display = 'none';
        return;
      }
      placeholder.style.display = 'none';
      mapEl.style.display = 'flex';
      if (window._aircraftMap) {
        window._aircraftMap.remove();
        window._aircraftMap = null;
      }
      if (window._planeMarker) window._planeMarker.remove();
      if (window._crashMarker) window._crashMarker.remove();
      if (replayInterval) clearInterval(replayInterval);

      const map = L.map('map').setView([route[0].lat ?? route[0][0], route[0].lon ?? route[0][1]], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
      const pts = route.map(p => [p.lat ?? p[0], p.lon ?? p[1]]);
      L.polyline(pts, { color: '#238636', weight: 4 }).addTo(map);
      route.forEach((p, i) => {
        const lat = p.lat ?? p[0], lon = p.lon ?? p[1];
        const color = i === 0 ? '#00c800' : '#3290d4';
        L.circleMarker([lat, lon], { radius: 6, fillColor: color, color: '#fff', weight: 2, fillOpacity: 1 }).addTo(map).bindPopup('WP' + (i + 1));
      });
      map.fitBounds(pts, { padding: [20, 20] });
      window._aircraftMap = map;

      if (!withReplay || !aircraftData || !aircraftData.model_parameters) return;
      const totalT = (route[route.length - 1].t ?? 0);
      const budget = aircraftData.model_parameters.energy_budget;
      const isPlane = true;
      const planeIcon = L.divIcon({ html: '<div style="width:16px;height:16px;border-radius:50%;background:#ffc800;border:2px solid #fff;"></div>', iconSize: [20, 20], iconAnchor: [10, 10] });
      const crashIcon = L.divIcon({ html: '<div style="width:20px;height:20px;background:#b42828;border-radius:50%;color:#fff;text-align:center;line-height:20px;font-size:14px;">✕</div>', iconSize: [24, 24], iconAnchor: [12, 12] });
      const failIcon = L.divIcon({ html: '<div style="width:20px;height:20px;background:#c85028;border-radius:50%;color:#fff;text-align:center;line-height:20px;font-size:12px;">▼</div>', iconSize: [24, 24], iconAnchor: [12, 12] });

      replayStartTime = Date.now() / 1000;
      let crashed = false;
      let crashPos = null;
      let crashIsPlane = true;

      function tick() {
        const elapsed = (Date.now() / 1000 - replayStartTime) * FLIGHT_SPEED;
        if (crashed && crashPos) {
          if (window._planeMarker) window._planeMarker.remove();
          if (!window._crashMarker) window._crashMarker = L.marker([crashPos.lat, crashPos.lon], { icon: crashIsPlane ? crashIcon : failIcon }).addTo(map);
          return;
        }
        const pos = interpolate(route, elapsed);
        if (!pos) return;
        const energy = interpolateEnergy(route, elapsed);
        if (energy && energy.energy_used >= energy.budget) {
          crashed = true;
          crashPos = pos;
          crashIsPlane = isPlane;
          document.getElementById('aircraft-crash-msg').style.display = isPlane ? 'block' : 'none';
          document.getElementById('aircraft-crash-msg').textContent = 'CRASHED (fuel out)';
          document.getElementById('aircraft-fail-msg').style.display = isPlane ? 'none' : 'block';
          document.getElementById('aircraft-fail-msg').textContent = 'FAILING DOWN (battery out)';
        }
        if (elapsed >= totalT && !crashed) {
          if (replayInterval) clearInterval(replayInterval);
          replayInterval = null;
        }
        if (window._crashMarker && crashed) return;
        if (window._planeMarker) window._planeMarker.setLatLng([pos.lat, pos.lon]);
        else window._planeMarker = L.marker([pos.lat, pos.lon], { icon: planeIcon }).addTo(map);
      }

      replayInterval = setInterval(tick, 50);
    }

    function routeFromData(d) {
      const route = d.planned_route || d.flight_path_with_timestamps || [];
      if (route && route.length >= 2) return route;
      const waypoints = d.waypoints_corrected_altitude || d.waypoints || [];
      if (!waypoints.length) return route;
      let t = 0;
      return waypoints.map((p, i) => {
        const lat = p[0], lon = p[1], alt = p[2] != null ? p[2] : 100;
        return { lat, lon, alt_m: alt, t: t++, energy_used: null };
      });
    }

    async function loadAircraft() {
      const metrics = document.getElementById('aircraft-metrics');
      document.getElementById('aircraft-crash-msg').style.display = 'none';
      document.getElementById('aircraft-fail-msg').style.display = 'none';
      try {
        const r = await fetch('/api/aircraft');
        if (!r.ok) {
          metrics.innerHTML = '';
          return;
        }
        const d = await r.json();
        aircraftData = d;
        const route = routeFromData(d);
        metrics.innerHTML = [
          '<div class="metric"><span>Time</span>' + (d.total_time_s != null ? d.total_time_s.toFixed(1) + ' s' : '—') + '</div>',
          '<div class="metric"><span>Energy</span>' + (d.total_energy != null ? d.total_energy.toFixed(0) : '—') + '</div>',
          '<div class="metric"><span>MC success</span>' + (d.monte_carlo && d.monte_carlo.success_rate != null ? (d.monte_carlo.success_rate * 100).toFixed(0) + '%' : '—') + '</div>'
        ].join('');
        showAircraftMap(route, true);
      } catch (e) {
        metrics.innerHTML = '';
      }
    }

    async function loadSpacecraft() {
      const wrap = document.getElementById('spacecraft-schedule-wrap');
      const metrics = document.getElementById('spacecraft-metrics');
      try {
        const r = await fetch('/api/spacecraft');
        if (!r.ok) {
          wrap.innerHTML = '<p class="error">No spacecraft data. Plan 7-day + Save to run.</p>';
          metrics.innerHTML = '';
          return;
        }
        const d = await r.json();
        const cc = d.constraint_checks || {};
        metrics.innerHTML = [
          '<div class="metric"><span>Mission value</span>' + (d.mission_value != null ? d.mission_value : '—') + '</div>',
          '<div class="metric"><span>Slew OK</span>' + (cc.slew_feasible != null ? cc.slew_feasible : '—') + '</div>',
          '<div class="metric"><span>Power OK</span>' + (cc.power_duty_ok != null ? cc.power_duty_ok : '—') + '</div>',
          '<div class="metric"><span>Activities</span>' + (d.activities ? d.activities.length : 0) + ' (saved to outputs/)</div>'
        ].join('');
        if (d.activities && d.activities.length) {
          let table = '<table class="schedule-table"><thead><tr><th>Type</th><th>Start</th><th>End</th><th>Dur</th></tr></thead><tbody>';
          d.activities.slice(0, 15).forEach(a => {
            table += '<tr><td>' + (a.type || '') + '</td><td>' + a.start_t + '</td><td>' + a.end_t + '</td><td>' + (a.end_t - a.start_t) + '</td></tr>';
          });
          table += '</tbody></table>';
          wrap.innerHTML = table;
        } else wrap.innerHTML = '';
      } catch (e) {
        wrap.innerHTML = '<p class="error">Failed to load.</p>';
        metrics.innerHTML = '';
      }
    }

    function getSpacecraftLaunchOrbit() {
      const latEl = document.getElementById('launch-lat');
      const lonEl = document.getElementById('launch-lon');
      const altEl = document.getElementById('orbit-alt-km');
      const launchLat = (latEl && !isNaN(parseFloat(latEl.value))) ? parseFloat(latEl.value) : 52;
      const launchLon = (lonEl && !isNaN(parseFloat(lonEl.value))) ? parseFloat(lonEl.value) : 4;
      const altKm = (altEl && !isNaN(parseFloat(altEl.value))) ? parseFloat(altEl.value) : 400;
      return { launchLat, launchLon, altKm };
    }

    function screenToEarthLatLon(mx, my, w, h, rotationRad) {
      const cx = w / 2, cy = h / 2;
      const earthR = Math.min(w, h) / 2 - 40;
      const dx = mx - cx, dy = my - cy;
      if (dx * dx + dy * dy > earthR * earthR) return null;
      const latRad = Math.asin(Math.max(-1, Math.min(1, -dy / earthR)));
      const cosLat = Math.cos(latRad);
      if (cosLat < 1e-9) return null;
      const lonViewRad = Math.atan2(dx, cosLat * earthR);
      let lonDeg = (lonViewRad + rotationRad) * 180 / Math.PI;
      if (lonDeg > 180) lonDeg -= 360;
      if (lonDeg < -180) lonDeg += 360;
      return { lat: latRad * 180 / Math.PI, lon: lonDeg };
    }

    const earthCache = {};
    function drawEarthCircle(ctx, cx, cy, earthR, rotationRad, imgCanvas) {
      const key = Math.round(rotationRad * 100) % 628;
      if (earthCache[key] && earthCache[key].width === earthR * 2) {
        ctx.drawImage(earthCache[key], cx - earthR, cy - earthR);
        return;
      }
      const off = document.createElement('canvas');
      off.width = earthR * 2;
      off.height = earthR * 2;
      const octx = off.getContext('2d');
      const tw = imgCanvas.width, th = imgCanvas.height;
      const imgData = octx.createImageData(off.width, off.height);
      const src = imgCanvas.getContext('2d').getImageData(0, 0, tw, th);
      for (let dy = -earthR; dy <= earthR; dy++) {
        for (let dx = -earthR; dx <= earthR; dx++) {
          if (dx * dx + dy * dy > earthR * earthR) continue;
          const lat = Math.asin(Math.max(-1, Math.min(1, dy / earthR)));
          const cosLat = Math.cos(lat);
          const lon = cosLat < 1e-6 ? 0 : Math.atan2(dx, cosLat * earthR);
          const u = ((lon + rotationRad) / (2 * Math.PI) + 0.5) % 1;
          const v = 0.5 - lat / Math.PI;
          const tx = Math.min(tw - 1, Math.floor(u * tw));
          const ty = Math.max(0, Math.min(th - 1, Math.floor(v * th)));
          const i = (ty * tw + tx) * 4;
          const o = ((dy + earthR) * off.width + (dx + earthR)) * 4;
          imgData.data[o] = src.data[i];
          imgData.data[o+1] = src.data[i+1];
          imgData.data[o+2] = src.data[i+2];
          imgData.data[o+3] = 255;
        }
      }
      octx.putImageData(imgData, 0, 0);
      earthCache[key] = off;
      ctx.drawImage(off, cx - earthR, cy - earthR);
    }

    function drawSpacecraftView() {
      const canvas = document.getElementById('spacecraft-canvas');
      if (!canvas) return;
      const w = canvas.clientWidth || 800;
      const h = canvas.clientHeight || 500;
      if (canvas.width !== w) canvas.width = w;
      if (canvas.height !== h) canvas.height = h;
      const ctx = canvas.getContext('2d');
      const cx = w / 2, cy = h / 2;
      const earthR = Math.min(w, h) / 2 - 40;
      const { launchLat, launchLon, altKm } = getSpacecraftLaunchOrbit();
      const EARTH_R_KM = 6371;
      const orbitR = Math.min(earthR * (EARTH_R_KM + altKm) / EARTH_R_KM, Math.min(w, h) / 2 - 10);

      ctx.fillStyle = '#1a1d21';
      ctx.fillRect(0, 0, w, h);

      if (earthImage && earthImage.complete && earthImage.naturalWidth && earthImage.naturalHeight) {
        try {
          const imgCan = document.createElement('canvas');
          imgCan.width = earthImage.naturalWidth;
          imgCan.height = earthImage.naturalHeight;
          imgCan.getContext('2d').drawImage(earthImage, 0, 0);
          drawEarthCircle(ctx, cx, cy, earthR, earthRotationRad, imgCan);
        } catch (err) {
          ctx.fillStyle = 'rgb(30, 60, 120)';
          ctx.beginPath();
          ctx.arc(cx, cy, earthR, 0, Math.PI * 2);
          ctx.fill();
        }
      } else {
        ctx.fillStyle = 'rgb(30, 60, 120)';
        ctx.beginPath();
        ctx.arc(cx, cy, earthR, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.strokeStyle = 'rgb(80, 120, 180)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(cx, cy, earthR, 0, Math.PI * 2);
      ctx.stroke();

      const latRad = launchLat * Math.PI / 180;
      const lonRad = launchLon * Math.PI / 180 - earthRotationRad;
      const lx = cx + earthR * Math.cos(latRad) * Math.sin(lonRad);
      const ly = cy - earthR * Math.sin(latRad);
      ctx.fillStyle = '#ffc800';
      ctx.beginPath();
      ctx.arc(lx, ly, 8, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.stroke();
      ctx.fillStyle = '#fff';
      ctx.font = '14px system-ui';
      ctx.fillText('Launch', lx - 18, ly - 12);

      ctx.strokeStyle = 'rgb(100, 100, 140)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(cx, cy, orbitR, 0, Math.PI * 2);
      ctx.stroke();

      const period = 2 * Math.PI * Math.sqrt(Math.pow(EARTH_R_KM + altKm, 3) / 398600.44);
      const angle = 2 * Math.PI * (Date.now() / 1000 % period) / period + earthRotationRad;
      const sx = cx + orbitR * Math.cos(angle);
      const sy = cy - orbitR * Math.sin(angle);
      ctx.fillStyle = 'rgb(200, 220, 255)';
      ctx.beginPath();
      ctx.arc(sx, sy, 6, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.stroke();
      ctx.fillStyle = 'rgb(200, 220, 255)';
      ctx.fillText('Spacecraft', sx - 24, sy - 10);
    }

    (function() {
      earthImage = new Image();
      earthImage.crossOrigin = 'anonymous';
      earthImage.src = EARTH_IMAGE_URL;
    })();

    let spacecraftCanvasDragStart = null;
    const canvas = document.getElementById('spacecraft-canvas');
    if (canvas) {
      canvas.addEventListener('mousedown', function(e) {
        if (!document.getElementById('spacecraft-viz').classList.contains('active')) return;
        spacecraftCanvasDragStart = { x: e.offsetX, y: e.offsetY };
      });
      canvas.addEventListener('mousemove', function(e) {
        if (!spacecraftCanvasDragStart) return;
        const dx = e.offsetX - spacecraftCanvasDragStart.x;
        earthRotationRad += dx * 0.008;
        spacecraftCanvasDragStart = { x: e.offsetX, y: e.offsetY };
      });
      canvas.addEventListener('mouseup', function(e) {
        if (!spacecraftCanvasDragStart) return;
        const dx = e.offsetX - spacecraftCanvasDragStart.x;
        const dy = e.offsetY - spacecraftCanvasDragStart.y;
        if (dx * dx + dy * dy < 16) {
          const rect = canvas.getBoundingClientRect();
          const w = canvas.clientWidth, h = canvas.clientHeight;
          const mx = e.clientX - rect.left, my = e.clientY - rect.top;
          const pt = screenToEarthLatLon(mx, my, w, h, earthRotationRad);
          if (pt) {
            const latEl = document.getElementById('launch-lat');
            const lonEl = document.getElementById('launch-lon');
            if (latEl) latEl.value = pt.lat.toFixed(2);
            if (lonEl) lonEl.value = pt.lon.toFixed(2);
            fetchWeatherAtLaunch();
          }
        }
        spacecraftCanvasDragStart = null;
      });
      canvas.addEventListener('mouseleave', function() { spacecraftCanvasDragStart = null; });
    }

    document.getElementById('set-launch-from-start-btn').addEventListener('click', function() {
      if (!settings || !settings.aircraft || !settings.aircraft.waypoints || !settings.aircraft.waypoints.length) return;
      const wp = settings.aircraft.waypoints[0];
      const latEl = document.getElementById('launch-lat');
      const lonEl = document.getElementById('launch-lon');
      if (latEl) latEl.value = wp[0];
      if (lonEl) lonEl.value = wp[1];
      fetchWeatherAtLaunch();
    });

    const launchLatEl = document.getElementById('launch-lat');
    const launchLonEl = document.getElementById('launch-lon');
    if (launchLatEl) launchLatEl.addEventListener('change', fetchWeatherAtLaunch);
    if (launchLonEl) launchLonEl.addEventListener('change', fetchWeatherAtLaunch);

    document.getElementById('plan-spacecraft-btn').addEventListener('click', async function() {
      const btn = this;
      const { launchLat, launchLon, altKm } = getSpacecraftLaunchOrbit();
      const tlist = (settings && settings.spacecraft && settings.spacecraft.targets) ? settings.spacecraft.targets : [[52.5, 4.5, 1], [53, 5, 1]];
      btn.disabled = true;
      try {
        const r = await fetch('/api/plan_spacecraft', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ station: [launchLat, launchLon], altitude_km: altKm, targets: tlist })
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          alert('Error: ' + (data.error || r.statusText));
          return;
        }
        await loadSpacecraft();
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('plan-aircraft-btn').addEventListener('click', async function() {
      const btn = this, status = document.getElementById('plan-aircraft-status');
      const ta = document.getElementById('aircraft-waypoints-ta');
      const lines = (ta && ta.value || '').trim().split('\n').map(s => s.trim()).filter(Boolean);
      const waypoints = [];
      for (const line of lines) {
        const parts = line.split(',').map(p => p.trim());
        if (parts.length >= 2) {
          const lat = parseFloat(parts[0]), lon = parseFloat(parts[1]);
          if (!isNaN(lat) && !isNaN(lon))
            waypoints.push(parts.length >= 3 ? [lat, lon, parseFloat(parts[2]) || undefined] : [lat, lon]);
        }
      }
      if (waypoints.length < 2) {
        status.textContent = 'Add at least 2 waypoints (lat, lon or lat, lon, alt per line).';
        status.className = 'error';
        return;
      }
      btn.disabled = true;
      status.textContent = 'Planning…';
      status.className = 'running';
      status.classList.remove('error');
      try {
        const defaultAlt = parseFloat(document.getElementById('aircraft-altitude-m').value) || 100;
        const vehicleType = (document.getElementById('aircraft-vehicle-type') && document.getElementById('aircraft-vehicle-type').value) || 'Plane';
        const energyCap = parseFloat(document.getElementById('aircraft-energy-capacity').value) || 2e6;
        const consumption = parseFloat(document.getElementById('aircraft-consumption').value) || 80;
        const payload = {
          waypoints: waypoints.map(w => w.length >= 3 ? [w[0], w[1], w[2]] : [w[0], w[1], defaultAlt]),
          default_altitude_m: defaultAlt,
          vehicle_type: vehicleType,
          energy_budget: energyCap,
          consumption_per_second: consumption
        };
        const r = await fetch('/api/plan_aircraft', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          status.textContent = 'Error: ' + (data.error || r.statusText);
          status.className = 'error';
          return;
        }
        status.textContent = 'Saved.';
        await loadAircraft();
      } catch (e) {
        status.textContent = 'Error: ' + e.message;
        status.className = 'error';
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('start-mission-btn').addEventListener('click', async function() {
      const btn = this, status = document.getElementById('start-mission-status');
      btn.disabled = true;
      status.textContent = 'Running…';
      status.className = 'running';
      status.classList.remove('error');
      try {
        const r = await fetch('/api/start_mission', { method: 'POST' });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          status.textContent = 'Error: ' + (data.error || r.statusText);
          status.className = 'error';
          return;
        }
        status.textContent = 'Done.';
        await loadSettings();
        await loadAircraft();
        await loadSpacecraft();
      } catch (e) {
        status.textContent = 'Error: ' + e.message;
        status.className = 'error';
      } finally {
        btn.disabled = false;
      }
    });

    loadSettings();
    loadAircraft();
    loadSpacecraft();
    setInterval(() => { if (document.getElementById('spacecraft-viz').classList.contains('active')) drawSpacecraftView(); }, 100);
  </script>
</body>
</html>
